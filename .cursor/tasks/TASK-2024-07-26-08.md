# Task: Refactor Agent Orchestration to Shared Module

**ID:** TASK-2024-07-26-08
**Status:** ðŸ“ Open
**Date Created:** 2024-07-26

**Description:**
Refactor the core agent orchestration logic (onboarding sequence, teaching loop with evaluators) from `app_chainlit.py` and `api.py` into a new shared module (`src/orchestration.py`). This will centralize the logic, ensure consistency between the Chainlit app and the API, improve maintainability, and allow `api.py` to be updated with the latest features (Step/Answer Evaluators).

**Plan:**
1.  **Identify Logic:** Analyze `app_chainlit.py` to pinpoint distinct logical blocks for session initialization, onboarding flow (OA -> PMA -> JCA), step evaluation, answer evaluation, and teacher prompting (initial & follow-up).
2.  **Create Shared Module:** Create `src/orchestration.py`.
3.  **Define Shared Functions:** Implement `async` functions in `src/orchestration.py` for the logic blocks. Design them to be state-independent: accept necessary agents and state data (like `current_step_index`, `last_teacher_message`, etc.) as arguments and return results (e.g., reply string) along with data needed for state updates (e.g., new step index, `AnswerEvaluationResult`).
4.  **Refactor Chainlit (`app_chainlit.py`):** Update `@cl.on_chat_start`, `@cl.on_message`, and helpers to:
    *   Retrieve state/agents from `cl.user_session`.
    *   Call the relevant functions in `src/orchestration.py`.
    *   Update `cl.user_session` based on the returned results.
5.  **Refactor API (`api.py`):** Update `initialize_session_state`, `process_message`, and helpers to:
    *   Retrieve state/agents from the `sessions` dictionary.
    *   Call the *same* functions in `src/orchestration.py`.
    *   Update the `sessions` dictionary based on the returned results.
    *   Ensure `initialize_session_state` includes all necessary agents (Step/Answer Evaluators) and state (`last_teacher_message`).
6.  **Testing:** Thoroughly test both applications to ensure functionality is preserved/corrected and consistent.

**Acceptance Criteria:**
*   `src/orchestration.py` exists and contains the core logic.
*   `app_chainlit.py` correctly uses the shared module and maintains its functionality.
*   `api.py` correctly uses the shared module and mirrors the updated Chainlit logic.
*   Redundant code between the two entry points is significantly reduced.

**Learnings:**
*(Will be filled in as work progresses)*
