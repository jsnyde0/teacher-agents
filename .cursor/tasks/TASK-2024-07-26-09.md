# Task: Integrate Teacher and Step Evaluator Agents for Multi-Step Plan Execution (v2)

**ID:** TASK-2024-07-26-09
**Status:** üìù Open
**Date Created:** 2024-07-26

## Description

Modify `app_chainlit.py` to orchestrate an interactive, multi-step teaching process. This involves using the `Teacher Agent` to present learning content for each step defined in a `LearningPlan` and employing the `Step Evaluator Agent` to intelligently determine when the user is ready to advance to the subsequent step, providing a more robust flow control than simple keyword matching.

## Relevant Specifications

*   Depends on implementations from TASK-2024-07-26-07 (Teacher Agent MVP) and TASK-2024-07-26-08 (Step Evaluator Agent).

## Acceptance Criteria

*   [ ] In `@cl.on_chat_start`, initialize instances of `Teacher Agent` and `Step Evaluator Agent` and store them in the user session.
*   [ ] In `@cl.on_chat_start`, initialize session variables `learning_plan: List[str] = None` and `current_step_index: int = -1`.
*   [ ] After the `Journey Crafter Agent` successfully generates a `LearningPlan`:
    *   Store the `plan.steps` list and `pedagogical_guidelines` string in the session.
    *   Set `current_step_index = 0`.
    *   Set `current_stage = "teaching"`.
    *   Trigger the presentation of the first step (Step 0).
*   [ ] Implement an `async def run_teacher_for_current_step(is_follow_up: bool = False)` helper function that:
    *   Retrieves agents, plan, guidelines, and current index from session.
    *   Constructs the prompt for the `Teacher Agent` conditionally:
        *   If `is_follow_up` is `False`, use a prompt to introduce/present the `learning_plan[current_step_index]` based on guidelines.
        *   If `is_follow_up` is `True`, use a prompt instructing the agent to re-engage the student on the *same* step, acknowledging they might be stuck, and asking a different question or providing alternative explanation based on guidelines (avoiding simple repetition).
    *   Runs the `Teacher Agent` within a try/except block.
    *   Returns the resulting teaching message string or an error message.
*   [ ] Call `run_teacher_for_current_step()` (with default `is_follow_up=False`) to present the first step upon entering the `teaching` stage and after a `PROCEED` evaluation for subsequent steps.
*   [ ] In `@cl.on_message`, when `current_stage == "teaching"`:
    *   Call the `Step Evaluator Agent` with `message.content` (within a try/except block, handling failure gracefully).
    *   **If Evaluator result is `PROCEED`:**
        *   Increment `current_step_index`.
        *   If `current_step_index` < `len(learning_plan)`: Call `run_teacher_for_current_step(is_follow_up=False)` for the new index and send the result.
        *   Else (plan complete): Send a concluding message and set `current_stage = "complete"`.
    *   **If Evaluator result is `STAY`:**
        *   Send a brief acknowledgement message (e.g., "Okay, seems like you're still working on this or have questions.").
        *   Immediately call `run_teacher_for_current_step(is_follow_up=True)` for the *same* `current_step_index` and send the result.
    *   **If Evaluator result is `UNCLEAR`:**
        *   Send a clarification-seeking message (e.g., "I couldn't quite tell if you're ready to proceed...").
*   [ ] Ensure the application correctly identifies the end of the plan and transitions to the `complete` stage.

## Learnings

*(Empty - to be filled during implementation)*
