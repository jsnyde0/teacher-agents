# Task: Integrate Teacher and Step Evaluator Agents for Multi-Step Plan Execution (v2)

**ID:** TASK-2024-07-26-09
**Status:** âœ… Done
**Date Created:** 2024-07-26
**Date Completed:** 2024-07-27

## Description

Modify `app_chainlit.py` to orchestrate an interactive, multi-step teaching process. This involves using the `Teacher Agent` to present learning content for each step defined in a `LearningPlan` and employing the `Step Evaluator Agent` to intelligently determine when the user is ready to advance to the subsequent step, providing a more robust flow control than simple keyword matching.

## Relevant Specifications

*   Depends on implementations from TASK-2024-07-26-07 (Teacher Agent MVP) and TASK-2024-07-26-08 (Step Evaluator Agent).

## Acceptance Criteria

*   [ ] In `@cl.on_chat_start`, initialize instances of `Teacher Agent` and `Step Evaluator Agent` and store them in the user session.
*   [ ] In `@cl.on_chat_start`, initialize session variables `learning_plan: List[str] = None`, `current_step_index: int = -1`, and `last_teacher_message: str | None = None`.
*   [ ] After the `Journey Crafter Agent` successfully generates a `LearningPlan`:
    *   Store the `plan.steps` list and `pedagogical_guidelines` string in the session.
    *   Set `current_step_index = 0`.
    *   Set `current_stage = "teaching"`.
    *   Trigger the presentation of the first step (Step 0).
*   [ ] Implement an `async def run_teacher_for_current_step(is_follow_up: bool = False, last_user_message: str | None = None)` helper function that:
    *   Retrieves agents, plan, guidelines, and current index from session.
    *   Constructs the prompt for the `Teacher Agent` conditionally:
        *   If `is_follow_up` is `False`, use a prompt to introduce/present the `learning_plan[current_step_index]` based on guidelines, immediately providing content/question.
        *   If `is_follow_up` is `True`, use a prompt instructing the agent to:
            1.  **Evaluate** the `last_user_message` for correctness/relevance against the `Current Learning Step`.
            2.  **Respond** by first addressing the correctness (stating if correct/incorrect, explaining errors), and then providing the next piece of feedback, hint, example, or question.
            3.  **Crucially, the *style and content* of the feedback/response MUST strictly follow the provided `Pedagogical Guideline`** (e.g., use Socratic questions if guided, provide code examples first if guided, etc.).
            4.  Avoid simple repetition or generic readiness checks.
    *   Runs the `Teacher Agent` within a try/except block.
    *   Returns the resulting teaching message string or an error message.
*   [ ] When sending a message from `run_teacher_for_current_step`, also store its content in `cl.user_session.set(\"last_teacher_message\", ...)`.
*   [ ] Call `run_teacher_for_current_step()` (with default `is_follow_up=False`) to present the first step upon entering the `teaching` stage and after a `PROCEED` evaluation for subsequent steps.
*   [ ] In `@cl.on_message`, when `current_stage == \"teaching\"`:
    *   Retrieve the `last_teacher_message` from the session.
    *   **Update `Step Evaluator Agent` (`src/agents/step_evaluator_agent.py` and tests):
        *   Modify system prompt to accept and consider both `last_teacher_message` and the user's current message (`message.content`).
        *   Instruct it to evaluate `PROCEED` only if the user explicitly signals moving on AND isn't simply acknowledging a teacher question/instruction.
        *   Adjust tests to provide pairs of (teacher message, user message) and assert correct outcomes (`PROCEED`, `STAY`, `UNCLEAR`).**
        *   Call the updated `Step Evaluator Agent` with both messages (within a try/except block, handling failure gracefully).
        *   **If Evaluator result is `PROCEED`:**
            *   Increment `current_step_index`.
    *   Call the updated `Step Evaluator Agent` with both messages (within a try/except block, handling failure gracefully).
    *   **If Evaluator result is `PROCEED`:**
        *   Increment `current_step_index`.
        *   If `current_step_index` < `len(learning_plan)`: Call `run_teacher_for_current_step(is_follow_up=False)` for the new index and send the result.
        *   Else (plan complete): Send a concluding message and set `current_stage = \"complete\"`.
    *   **If Evaluator result is `STAY` or `UNCLEAR`:**
        *   Call `run_teacher_for_current_step(is_follow_up=True, last_user_message=message.content)` for the *same* `current_step_index`.
        *   Send the resulting message (which should now be a direct, contextual response, potentially including correctness feedback) back to the user.
*   [ ] Ensure the application correctly identifies the end of the plan and transitions to the `complete` stage.

## Learnings

*(Empty - to be filled during implementation)*
